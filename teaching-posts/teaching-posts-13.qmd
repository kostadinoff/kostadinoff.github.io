---
title: "Регресионен анализ. Линейна регресия"
author: "Костадин Костадинов"
date: 2024-11-24
description: "Материалът представя основните понятия и стъпки при използването на линейна регресия в медицинската статистика."
categories: 
  - "Bulgarian"
  - "Medical Statistics"
  - "Medicine | 2nd year"
  - "Dental medicine | 2nd year"
language: custom.yml
title-meta: "Регресионен анализ. Линейна регресия"
author-meta: "Костадин Костадинов"
date-meta: 2024-11-24
---
```{r}
#| include: false
#| warning: false
# Load or install pacman
if (!require("pacman")) install.packages("pacman")

# Use pacman to install (if necessary) and load required packages
pacman::p_load(
  ggthemes, gt, gtsummary, showtext, ggeffects, patchwork, scales, sysfonts,
  ggsci, ggridges, rstatix, tidyverse, broom, janitor
)

```

```{r}
#| include: false
#| warning: false

showtext_auto()
font_add(family = "SofiaSansCondensed", regular = "SofiaSansCondensed-Regular.ttf")
# Define a custom theme


theme_nice <- ggthemes::theme_tufte() +
  theme(
    axis.ticks = element_line(linewidth = 0.5, color = "black"),
    axis.ticks.length = unit(4, "mm"),
    plot.title = element_text(
      family = "SofiaSansCondensed",
      size = 20,
      hjust = 0,
      vjust = 2
    ),
    plot.subtitle = element_text(
      family = "SofiaSansCondensed",
      size = 18),
    plot.caption = element_text(
      family = "SofiaSansCondensed",
      size = 16,
      hjust = 1
    ),
    axis.title = element_text(
      family = "SofiaSansCondensed",
      size = 18),
    axis.text = element_text(
      family = "SofiaSansCondensed",
      size = 18),
    axis.text.x = element_text(margin = margin(5, b = 10)),
    strip.text = element_text(
      family = "SofiaSansCondensed",
      size = 18),
    axis.line = element_line()
  )

# Set the defined theme as the default theme
theme_set(theme_nice)

```


# Същност на регресионния модел

Когато две променливи са свързани (в корелация помежду си, било то положителна или отрицателна), познаването на стойността на едната променлива позволява да **предскаже**, сравнително точно, стойността на другата. Това позволява да се правят полезни прогнози. Подобни "модели" са изключително важни в епидемиологията и клиничната медицина, а най-често използваният метод за тяхното създаване е **линейната регресия**. 

Променливата, чиито стойности се предсказват в регресионния модел се нарича зависима (резултативна), докато променливата, която се използва за предсказване и построяването на модела се нарича независима (факторна). В своята същност, регресионния анализ достига до "уравнение" (математическа функция) чрез което в аналитичен вид се представя връзката между определен набор от фактори и резултативното явление. Регресионното уравнение се представя като:

$${y} = {a} + {\beta}\cdot{x}$$


::: {.column-margin}

Нека приемем за зависима променлива $y$ - тегло на студентите от 2-ри курс, а за независима $x$ - калорийния им прием. Чрез линейната регресия връзката между тези променливи може да се моделира, така че при известни стойности за калорийния прием, да предскажем теглото на студента. Регресионният модел следва формулата: ${y} = {a} + {\beta}\cdot{x}$, в която:

- Коефициентът ${a}$ е **константа** (intercept). 

Стойността коефициента показва, какво е теглото, когато калорийният прием е нула. С други думи, ${a}$ посочва началната точка на взаимовръзката между тегло и калорийния прием и на практика, няма практическо значение в интерпретацията на модела, тя служи единствено за математическото моделиране.

- ${\beta}$ е **регресионният коефициент**. 

Това е число, което показва **силата и посоката** на връзката между предиктора (калорийния прием) и резултативната променлива (теглото). Математически, за установяване на стойността на $y$, трябва да умножи регресионния коефициент ${\beta}$ с известната стойност калорийния прием $x$. Отрицателните стойности на ${\beta}$ означават негативна (обратна) корелационна връзка, а позитивните стойности - позитивна (права).

:::

# Регресионно моделиране

Създаването на линеен регресионен модел протича в следните стъпки:

1. Избор на зависима и независима променлива;
2. Изчисляване на регресионния коефициент ${\beta}$
   1. Изчисляване на сумата на стойностите на променливите $x$ и $y$, както и сумата на всички произведения между на $x$ по $y$ за всяко едно наблюдение;
   2. Сбор на повдигнатите на квадрат стойности на променливата $x$ и умножение на получената сумата с броя на наблюденията;
3. Изчисляване на константата ${a}$
   1. Изчисляване на средната стойност на променливата $y$;
   2. Изчисляване на средната стойност на променливата $x$;
4. Интерпретация на модела. 

За да се представят етапите в тяхната последователност, се използва следния пример

::: column-page-right
:::: {.callout-tip collapse="false" appearance="default" icon="true"}

## Пример

Проучване измерва степента на тревожност сред 10 студенти в специалност "медицина", посредством въпросник със скала от 0 (най-ниска степен на тревожност) до 100 (най-висока степен на тревожност). Изследователският екип записва резултата от теста, както и времето (в минути) прекарано в четене по статистика в предходния ден за всеки един участник. Целта на изследването е да се построи **линеен регресионен модел** за предсказване на тревожността на студентите $y$ въз основа на времето прекарано в четене $x$.
::::
:::


## Избор на зависима и независима променлива

Изходните данни са представени в @tbl-regresion-data и на @fig-scater. Променливата `тревожност` e зависима, това означава, че изградения модел ще се опитва да *предскаже* стойността на тревожността във основа на променливата `учене по статистика`, която е независима или факторна.

| ${y}$ Тревожност (0 до 100) | ${x}$ учене по статистика (минути) |
|:---------------------------:|:----------------------------------:|
|             21              |                 45                 |
|             84              |                 90                 |
|             14              |                 20                 |
|             95              |                120                 |
|             84              |                100                 |
|             32              |                 62                 |
|             59              |                 70                 |
|             43              |                 69                 |
|             71              |                 85                 |
|              4              |                 15                 |

: Изходни данни за регресионен модел {#tbl-regresion-data}

```{r}
#| label: fig-scater
#| fig-cap: "Връзка между тревожност и време за учене по статистика"
#| column: margin
#| warings: false
#| message: false
#| echo: false

anxiety <- c(21, 84, 14, 95, 84, 32, 59, 43, 71, 4)
stat <- c(45, 90, 20, 120, 100, 62, 70, 69, 85, 15)
dat <- data.frame(stat, anxiety)
dat <- as_tibble(dat)
dat %>%
  ggplot(aes(anxiety, stat)) +
  geom_point(size = 3) +
  geom_smooth(
    method = "lm",
    lty = 2,
    linewidth = 2,
    se = F
  ) +
  guides(x = guide_axis(cap = "both"), y = guide_axis(cap = "both")) +
  expand_limits(y = c(0, 100), x = c(0, 100)) +
  labs(x = "тревожност", y = "време в минути")
```


## Изчисляване на регресионния коефициент бета

::: {.column-margin}
В числител:

- ${n}$ е броят на наблюденията;
- ${\sum{X}}$ е сумата от стойностите на независимата променлива ${x}$;
- ${\sum{Y}}$ е сумата от стойностите на зависимата променлива ${y}$;
- $\sum{(X.Y)}$ е сумата от всички произведения на стойностите на ${x}$ по стойностите на ${y}$ за всяко едно наблюдение.

В знаменателя:

-  ${n}$ е броят на наблюденията;
-  ${\sum{X^2}}$ е сумата от квадратите на стойностите на независимата променлива ${x}$;
-  ${(\sum{X})^2}$ е квадратът на сумата от стойностите на независимата променлива ${x}$.

:::

За изчисление на този коефициент се ползва формулата:

$$ {\beta}= \frac{({n}\cdot{\sum{({X}\cdot{Y}})})-(\sum{X}\cdot{\sum{Y}})}{({n}\cdot{\sum{X^2}))}-{(\sum{X})^2}}$$


### Изчисляване на сумата на стойностите на променливите $x$ и $y$, както и сумата на всички произведения между на $x$ по $y$ за всяко едно наблюдение;

В тази стъпка е необходимо да установи сборът на всички наблюдения за двете променливи. След това е необходимо да се установи сумата $\sum{(X.Y)}$ от произведенията на стойностите на променливите ${x}$ по ${y}$ - за за всеки един студент. Резултатите са представени таблично в @tbl-regresion-data-sum.

| ${y}$ Тревожност |  ${x}$ учене  |    ${x}\cdot{y}$    |
|:----------------:|:-------------:|:-------------------:|
|        21        |      45       |         945         |
|        84        |      90       |        7560         |
|        14        |      20       |         280         |
|        95        |      120      |        11400        |
|        84        |      100      |        8400         |
|        32        |      62       |        1984         |
|        59        |      70       |        4130         |
|        43        |      69       |        2967         |
|        71        |      85       |        6035         |
|        4         |      15       |         60          |
|  $\sum{Y}=507$   | $\sum{X}=676$ | $\sum{(X.Y)}=43761$ |

: Първа стъпка за изчисляване на регресионния коефициент {#tbl-regresion-data-sum}


В резултат от тази стъпка се установява числителят в формулата за изчисляване на регресионния коефициент ${\beta}$

$$({n}\cdot{\sum{({X}\cdot{Y}})})-(\sum{X}\cdot{\sum{Y}})=10\cdot{43761}-676\cdot{507}=437610-342732=94878$$

### Сбор на квадратите за променливата $x$

В тази стъпка се повдигат на квадрат всички стойности на променливата ${x}$, след което се сумират. Резултатът е представен в @tbl-regresion-data-sum2.

| ${x}$ учене по статистика (минути) |      ${x^2}$      |
|:----------------------------------:|:-----------------:|
|                 45                 |       2025        |
|                 90                 |       8100        |
|                 20                 |        400        |
|                120                 |       14400       |
|                100                 |       10000       |
|                 62                 |       3844        |
|                 70                 |       4900        |
|                 69                 |       4761        |
|                 85                 |       7225        |
|                 15                 |        225        |
|           $\sum{x}=676$            | $\sum{x^2}=55880$ |

: Втора стъпка за изчисляване на регресионния коефициент {#tbl-regresion-data-sum2}

В края на втора стъпка получаваме знаменателя в формулата за изчисляване на регресионния коефициент ${\beta}$

$$({n}\cdot{\sum{X^2}})-{(\sum{X})^2}=10\cdot{55880}-676^2=558800-456976=101824$$

### Изчисляване на регресионния коефициент ${\beta}$

След като сме установили числителя и знаменателя заместваме във формулата:

$$ {\beta}= \frac{({n}\cdot{\sum{{X}\cdot{Y}}})-\sum{X}\cdot{\sum{Y}}}{{n}\cdot{\sum{X^2}}-{(\sum{X})^2}}$$

$$ {\beta}= \frac{94878}{101824} = 0,93$$

## Изчисляване на константата ${a}$

::: {.column-margin}
Където:

- ${\bar{y}}$ е средната стойност на зависимата променлива ${y}$;
- ${\bar{x}}$ е средната стойност на независимата променлива ${x}$.
- ${\beta}$ е регресионният коефициент.
- ${a}$ е константата.
:::

За изчисляване на константата използваме формулата:

$${a}={\bar{y}}-({\beta}\cdot{\bar{x}})$$

### Изчисляване на средната стойност на зависимата променлива ${y}$

За да изчислим средната стойност на зависимата променлива ${y}$ ползваме формулата за средна аритметична:

$${\bar{y}}=\frac{\sum{Y}}{n}$$

$${\bar{y}}=\frac{507}{10}=50,7$$

### Изчисляване на средната стойност на независимата променлива ${x}$

Отново прилагаме формулата:

$${\bar{x}}=\frac{\sum{X}}{n}$$

$${\bar{x}}=\frac{676}{10} = 67,6$$

### Изчисляване на константата ${a}$

Заместваме в израза за константата:
$${a}={\bar{y}}-({\beta}\cdot{\bar{x}})$$

$${a}=50,7-(0,93\cdot{67,6})$$
$${a}=-12.2$$


## Интерпретация: 

1. **Регресионният коефициент** е позитивно число - това означава, че увеличаването на времето в четене по статистика, се свързва с увеличение на тревожността. Връзката е сравнително силна, като увеличение с една минута четене води до увеличение с 0,93 точки в теста за тревожност;
2. **Константата "а"** има значение единствено като *"начална точка"*. Това число показва стойността на зависимата променлива (тревожност), ако фактора (време прекарано в четене) е равен на 0. 

Математически моделът се представя като:

$${y} = {a} + {\beta}\cdot{x}=-12,2+0,93\cdot{x}$$

# Регресионно прогнозиране (използване на модела за предсказване)

Да приемем, че нов студент се премести в групата. Знаейки само колко време чете по статистика е необходимо да преценим, какъв би бил резултатът му от теста за тревожност. Да приемем, че студентът е споделил, че прекарва в четене 30 мин на ден. Прилагаме модела [^1]:

$${y} = {a} + {\beta}\cdot{x}=-12,2+0,93\cdot{x}$$

За новия студент ${x}=30$ минути. Заместваме в уравнението:
$${y} =-12,2+0,93\cdot{30}=16$$

[^1]: Много компютърни програми използват методи подобни на регресията за целите на маркетинга. Някои интернет страници запаметяват последните ви търсения и в основа на данни за вас (независими променливи или фактори) ви "предлагат" определени продукти, които за които има по-голяма вероятност да се интересувате (зависима променлива). В медицината регресия се използва наравно с медицинската слушалка. В кардиологията например рискът от инсулт се изчислява, използвайки именно регресионен модел наречен *CHADVAS score*

# Оценка на регресионния модел

Всеки регресионен модел се оценява спрямо **способността му да предсказва правилно**. Тази оценка се извършва чрез показателя коефициент на определеност (**детерминирания**)- ${R^2}$. Този коефициент:

1. Има стойности между 0 и 1 (0 и 100%);
2. Определя силата на модела - способността му да предсказва правилно;
3. Показва каква част от вариацията на зависимата променлива се обяснява от вариацията на независимата променлива;
4. Позволява да се оцени коефициентът на корелация, чрез формулата:

$${|r|=\sqrt{R^2}}$$

В посоченият по-горе пример, ако приемем, че коефициентът на детерминирания е 0,93, това означава, че **93%** от вариацията в тревожността в групата се обяснява следствие на вариацията в времето за четене по статистика. Двете променливи са в права (позитивна) корелационна връзка, чиито коефициент е:

$${|r|=\sqrt{R^2}}=\sqrt0,93=\pm 0,946$$

## Общо правило за интерпретация на регресията:

1. Регресионният коефициент ${\beta}$, показва, как се променя резултатът (зависимата променлива) при **една единица повишаване на фактора** (предиктора). 
2. Позитивен регресионен коефициент означава позитивна корелационна връзка между фактора и резултата. Обратно, негативен регресионен коефициент означава обратна (негативна) връзка между фактора и резултата. 
3. ${R^2}$ представя какъв дял от вариацията на резултативната променлива се дължи на изследвания фактор. 
4. Когато коренуваме стойността на ${R^2}$ получаваме **абсолютната стойност на корелационния коефициент** $\sqrt{R^2}={|r|}$. 
5. Знакът *+* или *-* пред коефициентът на корелация **се определя** от знака пред регресионния коефициент ${\beta}$. 

# Още малко за регресията

::: {.callout-note collapse="false" appearance="default" icon="true"}

## Множествена регресия

Представения до момента регресионен модел съдържа само една "обясняваща" променлива. Затова такива модели се означават като "еднофакторни".В действителност, за да обясним една променлива, често се използват множество предиктори (независими променливи). Всеки един от тях има собствен регресионен коефициент. В тези случай често се наблюдава статистическия феномен "колинеарност". При него две или повече независими са в **силна корелационна връзка помежду си**, при което тяхната способност да предсказват зависима променлива намалява.

:::

# Тестове и задачи

## Задача 1

Данните регистрирани в таблицата по-долу са на пациенти, участници в проучване на коронарната болест на сърцето. Изградете регресионен модел с който да предскажете стойността на холестерола в кръвта на пациентите спрямо теглото им.

| Тегло (кг) | Холестерол (мг/дл) |
|:----------:|:------------------:|
|     84     |        135         |
|    107     |        222         |
|     94     |        244         |
|     83     |        252         |
|    131     |        269         |
|     72     |        286         |
|     87     |        294         |
|     88     |        302         |
|     77     |        311         |
|     90     |        311         |
|     79     |        312         |
|     82     |        353         |
|     70     |        403         |
|     88     |        403         |

## Задача 2

При проучване на нов анестетик е отчетено времето от подаването на медикамента до реакцията на пациента и съответната ефективна доза, определена в мкг/кг. Данните са показани в таблицата по-долу. Изградете регресионен модел с който да предсказвате времето за реакция в зависимост от дозата на медикамента.

| Доза (мкг/кг) | Време (сек) |
|:-------------:|:-----------:|
|      1,3      |     25      |
|       9       |     13      |
|      1,5      |     19      |
|      1,1      |     23      |
|       1       |     26      |
|      1,3      |     21      |
|      2,1      |     11      |
|      1,7      |     30      |
|      1,6      |     14      |
|      0,9      |     24      |

## Тестове

1.	Множествената (многофакторна) линейна регресия моделира:

a)	Резултат за 1 независима променлива въз основа на данни за 1 зависима променлива.
b)	Резултат за 1 зависима променлива въз основа на данни за 1 независима променлива.
c)	Резултат за 1 независима променлива въз основа на данни за повече от 1 зависими променливи.
d)	Резултат за 1 зависима променлива въз основа на данни за повече от 1 независими променливи.

2. Големият положителен наклон на регресионната крива означава, че:

a) корелацията е силна и положителна;
b) вертикалното изместване е голямо и положително;
c) стойността на У ще се увеличи поне с няколко единици, когато стойността на X се увеличи с една единица;
d) всички гореизброени са верни.

3. Ако коефициентът на детерминация е положителен, то простата (единична) линейна регресия:

a) Има положителен (нарастващ) наклон.
b) Има отрицателен (намаляващ) наклон.
c) Може да има или положителен, или отрицателен наклон.
d) Зависимата променлива Y е отрицателна.

4. Каква е целта на простата (единична) линейна регресия?

a) Прогнозиране на зависима променлива въз основа на данни за една независима променлива.
b) Прогнозиране на независима променлива въз основа на данни за една зависима променлива.
c) Прогнозиране на зависима променлива въз основа на данни за повече от една независими променливи.
d) Прогнозиране на независима променлива въз основа на данни за повече от една зависими променливи.

5. Регресионен коефициент b = 0.85 означава:

a) Положителен наклон на правата на най-добро съответствие
b) Отрицателен наклон на правата на най-добро съответствие
c) Наклонът на правата на най-добро съответствие може да бъде както положителен, така и отрицателен
d) Всички отговори са грешни

## Отворени въпроси

Какъв извод може да се направи въз основа на регресионния модел, представен на графиката по-долу? Как интерпретираме коефициента на детерминация в този случай? Каква е стойността на коефициента на корелация?

![Вариант 1](./images/regression1.png){width=70%}

![Вариант 2](./images/regression2.png){width=70%}

![Вариант 3](./images/regression3.png){width=70%}

